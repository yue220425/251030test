<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>質問集ビューア（JSON自動読込）</title>
  <style>
    :root { --bg: #0f172a; --card: #111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; }
    html,body{height:100%;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px;}
    .card{background:rgba(17,24,39,.7);backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:clamp(20px,2.8vw,28px);margin:0 0 12px 0}
    .muted{color:var(--muted)}
    .controls{display:grid; gap:10px; grid-template-columns:1fr;}
    .controls input[type="text"], .controls input[type="url"]{width:100%; padding:12px 14px; background:#0b1020; border:1px solid #263044; color:var(--text); border-radius:12px; outline:none}
    .controls .row{display:grid; gap:10px; grid-template-columns:1fr auto; align-items:center}
    .btn{appearance:none;border:1px solid #2b354a;background:#0d1628;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#3b4763}
    .grid{margin-top:16px; display:grid; gap:10px}
    .item{border:1px solid #23304a; border-radius:14px; overflow:hidden; background:#0c1323}
    .head{display:flex; gap:10px; align-items:flex-start; padding:12px 14px}
    .id{flex:0 0 auto; font-weight:700; color:#9be8f7; background:#04202a; border:1px solid #113a47; padding:4px 8px; border-radius:8px;}
    .title{flex:1 1 auto}
    .title .clip{display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    details{border-top:1px solid #1b2336}
    details[open]{background:#0a1020}
    summary{list-style:none; padding:12px 14px; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
    summary::-webkit-details-marker{display:none}
    .count{font-variant-numeric: tabular-nums;}
    .pill{display:inline-flex;align-items:center;gap:6px; padding:6px 10px; border:1px solid #26465a; background:#06121c; border-radius:999px; font-size:12px; color:#a7c3d8}
    .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; background:#0e1a2c; border:1px solid #283a5a; padding:2px 6px; border-radius:6px; color:#cdd9ed}
    .footer{margin-top:18px; font-size:12px}
    .loading{margin-top:14px;color:#bfe7ff}
    .danger{color:#fda4af}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>質問集ビューア</h1>
      <div class="muted">同一フォルダの <span class="kbd">qa_questions_clean.json</span> を<strong>自動読込</strong>します。必要なら別URL（JSON/CSV）を指定して「読み込む」。</div>
      <div style="height:8px"></div>
      <div class="controls">
        <div class="row">
          <input id="dataUrl" type="url" placeholder="① データURL（JSON/CSV。相対パスOK：qa_questions_clean.json）" />
          <button id="loadBtn" class="btn">読み込む</button>
        </div>
        <input id="q" type="text" placeholder="② キーワードで検索（例：ロールモデル / 配慮 / グレーゾーン）」/>
        <div class="flex">
          <label class="pill"><input type="checkbox" id="caseSensitive"/> 大文字小文字を区別</label>
          <label class="pill"><input type="checkbox" id="regex"/> 正規表現で検索</label>
          <span class="pill count" id="stats">0件</span>
          <label class="pill"><input type="file" id="localFile" accept=".csv,.json"/> ローカルで試す</label>
        </div>
      </div>
      <div id="loading" class="loading" hidden>読み込み中…</div>
      <div id="error" class="loading danger" hidden></div>
      <div id="list" class="grid" aria-live="polite"></div>
      <div class="footer muted">URLに <span class="kbd">#src=（データURL）</span> を付けると自動読込します。JSONは <b>NaN, Infinity</b> を含まずに保存してください（含む場合はビューア側で null に補正）。</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const listEl = document.getElementById('list');
    const statsEl = document.getElementById('stats');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const qEl = document.getElementById('q');
    const caseEl = document.getElementById('caseSensitive');
    const regexEl = document.getElementById('regex');

    const DEFAULT_SRC = 'qa_questions_clean.json'; // 同ディレクトリに置く

    let rows = [];
    let view = [];
    let cols = [];

    function detectType(u){ return /\.json($|\?)/i.test(u) ? 'json' : 'csv'; }

    function sanitizeJsonText(txt){
      // 非標準トークンをnullに補正（Unexpected token防止）
      return txt.replace(/\bNaN\b/g, 'null').replace(/\bInfinity\b/g, 'null').replace(/\b-Infinity\b/g, 'null');
    }

    function normalizeSheetUrl(u){
      if(!u) return u;
      if(/\.json($|\?)/i.test(u)) return u; // JSONはそのまま
      if(/output=csv/.test(u)) return u;
      if(/https:\/\/docs\.google\.com\/spreadsheets\/d\/e\//.test(u) && /\/pubhtml/.test(u)){
        return u.replace(/\/pubhtml(\?.*)?$/i, '/pub?output=csv');
      }
      const m1 = u.match(/https:\/\/docs\.google\.com\/spreadsheets\/d\/([^/]+)\/.*?[?#]gid=(\d+)/);
      if(m1){ const id=m1[1], gid=m1[2]; return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`; }
      const m2 = u.match(/https:\/\/docs\.google\.com\/spreadsheets\/d\/([^/]+)/);
      if(m2){ const id=m2[1]; return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=0`; }
      return u;
    }

    function loadAny(url){
      const u = normalizeSheetUrl(url);
      const kind = detectType(u);
      loading(true);
      errorEl.hidden = true;
      if(kind==='json'){
        fetch(u, {cache:'no-store'}).then(r=>{
          if(!r.ok) throw new Error('HTTP '+r.status);
          return r.text();
        }).then(t=>{
          const safe = sanitizeJsonText(t);
          const data = JSON.parse(safe);
          onParsedArray(data);
        }).catch(err=> showError('読み込みに失敗しました: ' + err.message));
      }else{
        Papa.parse(u, { download:true, header:true, skipEmptyLines:true, complete:onParsedCsv, error:(e)=>showError('CSV読み込み失敗: '+(e?.message||'未知のエラー')) });
      }
    }

    function onParsedCsv(res){
      loading(false);
      if(!res?.data?.length){ showError('CSVが空でした'); return; }
      rows = res.data.map(r=>fixRow(r));
      afterLoad();
    }
    function onParsedArray(data){
      loading(false);
      if(!Array.isArray(data) || !data.length){ showError('JSONが空でした'); return; }
      rows = data.map(r=>fixRow(r));
      afterLoad();
    }
    function afterLoad(){
      cols = Object.keys(rows[0]||{});
      view = rows.slice();
      render(view);
    }

    function fixRow(obj){
      const keys = Object.keys(obj);
      if(keys.length===1){
        const k = keys[0];
        const v = obj[k];
        const m = typeof v === 'string' ? v.split(/\\t|\\s{2,}/) : null;
        if(m && m.length>=2){ return { ID:m[0], questions:m.slice(1).join(' ') }; }
      }
      return obj;
    }

    function render(items){
      listEl.innerHTML = '';
      const frag = document.createDocumentFragment();
      items.forEach((r, i) => {
        const id = r.ID ?? r.id ?? r.Id ?? r[cols[0]] ?? String(i+1);
        const text = r.questions ?? r.Question ?? r.TEXT ?? r[cols[1]] ?? '';
        const item = document.createElement('div');
        item.className = 'item';
        item.id = 'q-' + (id+'').replace(/[^\\w-]+/g,'');
        item.innerHTML = `
          <div class="head">
            <div class="id">${escapeHtml(id)}</div>
            <div class="title"><div class="clip">${escapeHtml(text)}</div></div>
          </div>
          <details>
            <summary>詳細を表示</summary>
            <div style="padding:12px 14px; white-space:pre-wrap; line-height:1.6">${escapeHtml(text)}</div>
          </details>`;
        frag.appendChild(item);
      });
      listEl.appendChild(frag);
      const stats = document.getElementById('stats'); if(stats) stats.textContent = `${items.length}件`;
    }

    function escapeHtml(s){ return (s==null?''+s:s+'').replace(/[&<>\"']/g, c=>({\"&\":\"&amp;\",\"<\":\"&lt;\",\">\":\"&gt;\",\"\\\"\":\"&quot;\",\"'\":\"&#39;\"}[c])); }

    function applyFilter(){
      const term = qEl.value.trim();
      if(!term){ render(rows); return; }
      try{
        let pred;
        if(regexEl.checked){
          const flags = caseEl.checked ? 'u' : 'iu';
          const re = new RegExp(term, flags);
          pred = (t)=> re.test(t);
        }else{
          const needle = caseEl.checked ? term : term.toLowerCase();
          pred = (t)=> (caseEl.checked? t : t.toLowerCase()).includes(needle);
        }
        const filtered = rows.filter(r => pred((r.questions ?? r.Question ?? r.TEXT ?? r[cols[1]] ?? '').toString()));
        render(filtered);
      }catch(err){ errorEl.hidden=false; errorEl.textContent = '検索エラー: ' + err.message; }
    }

    qEl.addEventListener('input', applyFilter);
    caseEl.addEventListener('change', applyFilter);
    regexEl.addEventListener('change', applyFilter);

    document.getElementById('loadBtn').addEventListener('click', () => {
      const raw = document.getElementById('dataUrl').value.trim();
      if(!raw){ showError('データURLを入力してください'); return; }
      loadAny(raw);
      history.replaceState(null, '', '#src=' + encodeURIComponent(raw));
    });

    document.getElementById('localFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      loading(true);
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      if(ext==='json'){
        const reader = new FileReader();
        reader.onload = () => {
          try{ onParsedArray(JSON.parse(sanitizeJsonText(reader.result))); }catch(err){ showError('JSONパース失敗: ' + err.message); }
        };
        reader.onerror = (err)=> showError('読込失敗: ' + (err?.message||'未知のエラー'));
        reader.readAsText(file, 'utf-8');
      }else{
        Papa.parse(file, { header:true, skipEmptyLines:true, complete: onParsedCsv, error:(e)=>showError('CSV読み込み失敗: '+(e?.message||'未知のエラー')) });
      }
    });

    function loading(b){ loadingEl.hidden = !b; errorEl.hidden = true; }
    function showError(msg){ loading(false); errorEl.hidden=false; errorEl.textContent = msg; }

    // 初期化：#src があればそれを、無ければ DEFAULT_SRC(JSON) を自動読込
    (function initFromHash(){
      const m = location.hash.match(/#src=([^]+)$/);
      if(m){
        const u = decodeURIComponent(m[1]);
        document.getElementById('dataUrl').value = u;
        loadAny(u);
      } else if (DEFAULT_SRC){
        document.getElementById('dataUrl').value = DEFAULT_SRC;
        loadAny(DEFAULT_SRC);
      }
    })();
  </script>
</body>
</html>
