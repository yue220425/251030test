<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV / JSON ビューワー</title>

  <!-- 外部ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

  <style>
    body { max-width: 1000px; margin: 24px auto; padding: 0 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    .toolbar { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .input { width: 100%; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 8px; }
    .btn { padding: 10px 16px; border: 1px solid #111; background: #111; color: #fff; border-radius: 8px; cursor: pointer; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .hint { color: #666; font-size: 12px; margin-top: 6px; }
    .error { color: #b00020; margin: 8px 0 0; }
    #table { margin-top: 16px; }
  </style>
</head>

<body>
  <h1>CSV / JSON ビューワー</h1>

  <div class="toolbar">
    <input id="sheetUrl" class="input" type="text"
      placeholder="例）data.csv（同階層） / https://example.com/data.csv または data.json のURL" />
    <button id="loadBtn" class="btn">読み込む</button>
  </div>
  <div class="hint">同一オリジンのファイル推奨（GitHub Pagesなら <code>index.html</code> と同階層に <code>data.csv</code> を置く）</div>
  <div id="status" class="error"></div>

  <div id="table">ファイルを指定して「読み込む」を押してください。</div>

  <script>
    // ===== 設定 =====
    // 初期表示で自動読込する既定の相対パス。必要に応じて qa_questions_clean.json 等に変更可。
    const DEFAULT_SRC = 'qa_questions_clean.json';

    // ===== ユーティリティ =====
    const $ = (sel) => document.querySelector(sel);
    const isJson = (s) => /\.json(\?|#|$)/i.test(s.trim());

    const showError = (msg) => {
      $('#status').textContent = msg || '';
    };

    const setLoading = (loading) => {
      $('#loadBtn').disabled = !!loading;
      $('#table').setAttribute('aria-busy', loading ? 'true' : 'false');
    };

    const parseQueryHash = () => {
      // URLハッシュ #src=... を拾う
      const h = location.hash.slice(1);
      if (!h) return null;
      const params = new URLSearchParams(h);
      return params.get('src');
    };

    const updateHash = (src) => {
      history.replaceState(null, '', '#src=' + encodeURIComponent(src));
    };

    // ===== レンダリング =====
    let gridInstance = null;

    const renderGrid = (columns, rows) => {
      // 既存のGridを破棄
      if (gridInstance && gridInstance.destroy) {
        gridInstance.destroy();
        gridInstance = null;
      }
      // Grid.js に渡す
      gridInstance = new gridjs.Grid({
        columns,
        data: rows,
        search: { enabled: true, placeholder: '検索...' },
        sort: true,
        pagination: { enabled: true, limit: 20 },
        language: {
          search: { placeholder: '検索...' },
          pagination: {
            previous: '前',
            next: '次',
            showing: '表示中',
            results: '件'
          }
        }
      });
      gridInstance.render(document.getElementById('table'));
    };

    const normalizeToGrid = (objArray) => {
      if (!Array.isArray(objArray) || objArray.length === 0) {
        return { columns: [], rows: [] };
      }
      const columns = Array.from(
        objArray.reduce((set, row) => {
          Object.keys(row || {}).forEach(k => set.add(k));
          return set;
        }, new Set())
      );
      const rows = objArray.map(r => columns.map(c => (r && r[c] != null) ? String(r[c]) : ''));
      return { columns, rows };
    };

    // ===== ローダー =====
    const loadCsv = async (url) => {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`CSV取得に失敗しました (${res.status})`);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      const { columns, rows } = normalizeToGrid(parsed.data);
      if (!columns.length) throw new Error('CSVに表示できる列がありません');
      renderGrid(columns, rows);
    };

    const loadJson = async (url) => {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`JSON取得に失敗しました (${res.status})`);
      const data = await res.json();
      // JSONは配列のオブジェクトを想定（例：[{ID: "...", questions: "..."}]）
      const arr = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
      if (!Array.isArray(arr) || !arr.length) throw new Error('JSONの配列データが見つかりません');
      const { columns, rows } = normalizeToGrid(arr);
      renderGrid(columns, rows);
    };

    const loadBySrc = async (src) => {
      showError('');
      setLoading(true);
      try {
        if (isJson(src)) {
          await loadJson(src);
        } else {
          await loadCsv(src);
        }
      } catch (e) {
        showError(e.message || String(e));
        $('#table').textContent = '読み込みに失敗しました。';
        console.error(e);
      } finally {
        setLoading(false);
      }
    };

    // ===== イベント =====
    document.getElementById('loadBtn').addEventListener('click', () => {
      const raw = document.getElementById('sheetUrl').value.trim();
      if (!raw) { showError('データURLを入力してください'); return; }
      loadBySrc(raw);
      updateHash(raw);
    });

    // Enterキーで読み込み
    document.getElementById('sheetUrl').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        $('#loadBtn').click();
      }
    });

    // ===== 初期化：#src= または DEFAULT_SRC を自動読込 =====
    (async () => {
      const fromHash = parseQueryHash();
      const initial = fromHash || DEFAULT_SRC; // 例: 'data.csv'
      $('#sheetUrl').value = initial;
      await loadBySrc(initial);
      updateHash(initial);
    })();
  </script>
</body>
</html>

