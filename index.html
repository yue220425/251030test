<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV / JSON ビューワー（階層タグ＋ワイド列・修正版）</title>

  <!-- 外部ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

  <style>
    :root{
      --pill-bg:#f3f4f6; --pill-bd:#d1d5db; --pill-tx:#374151;
      --pill-on-bg:#111827; --pill-on-bd:#111827; --pill-on-tx:#fff;
      --pill-hover:#e5e7eb;
    }
    body {
      max-width: 1100px; margin: 24px auto; padding: 0 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      overflow-x: hidden; /* ページ全体の横スクロール抑止 */
    }
    h1 { margin: 0 0 12px; }
    .toolbar { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .input { width: 100%; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 8px; }
    .btn { padding: 10px 16px; border: 1px solid #111; background: #111; color: #fff; border-radius: 8px; cursor: pointer; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .hint { color: #666; font-size: 12px; margin-top: 6px; }
    .error { color: #b00020; margin: 8px 0 0; }

    /* タグ（横スクロールしない・折返し） */
    .facet-wrap{ margin-top:18px; }
    .facet-title{ font-weight:700; margin:20px 0 8px; }
    .facet-row{ display:flex; flex-wrap:wrap; gap:8px; }
    .facet-group{ margin-bottom:12px; }
    .facet-group .facet-row{ margin-left:8px; }
    .facet-group-label{ font-weight:600; margin:8px 0 4px; opacity:.85; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--pill-bd); background:var(--pill-bg);
      color:var(--pill-tx); border-radius:999px; cursor:pointer; user-select:none; font-size:14px;
    }
    .pill:hover{ background:var(--pill-hover); }
    .pill[data-on="1"]{ background:var(--pill-on-bg); border-color:var(--pill-on-bd); color:var(--pill-on-tx); }
    .pill .count{ font-size:12px; opacity:.65; }
    .facet-actions{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn-ghost{ padding:6px 10px; border:1px solid #d1d5db; background:#fff; color:#111; border-radius:8px; cursor:pointer; }
    .btn-ghost:hover{ background:#f9fafb; }
    .divider{ height:1px; background:#e5e7eb; margin:18px 0; }

    /* テーブル領域だけ横スクロール */
    .table-area{ margin-top:16px; max-width:100%; overflow-x:auto; overflow-y:visible; contain: content; }
    .gridjs-container{ max-width:100%; overflow: visible; }
    .gridjs-wrapper{ max-width:100%; width: max-content; }
    .gridjs-td, .gridjs-th { white-space: normal; }
    .gridjs-td { word-break: break-word; }
  </style>
</head>

<body>
  <h1>CSV / JSON ビューワー（階層タグ＋ワイド列・修正版）</h1>

  <div class="toolbar">
    <input id="sheetUrl" class="input" type="text" placeholder="例）qa_questions_clean.json / data.csv（同階層） / 公開URL" />
    <button id="loadBtn" class="btn">読み込む</button>
  </div>
  <div class="hint">同一オリジン推奨（GitHub Pagesなら <code>index.html</code> と同階層に置く）</div>
  <div id="status" class="error"></div>

  <!-- 階層ファセット -->
  <div id="facetTop" class="facet-wrap">
    <div class="facet-title">大分類</div>
    <div id="facetTopRow" class="facet-row"></div>
    <div class="facet-actions"><button id="clearTop" class="btn-ghost">大分類のみ 選択解除</button></div>
  </div>

  <div class="facet-wrap">
    <div class="facet-title">中分類（大分類に応じて表示）</div>
    <div id="facetMid" class="facet-group"></div>
    <div class="facet-actions"><button id="clearMid" class="btn-ghost">中分類のみ 選択解除</button></div>
  </div>

  <div class="divider"></div>

  <!-- その他ファセット -->
  <div id="facetOther" class="facet-wrap">
    <div class="facet-title">その他の絞り込み</div>
    <div class="facet-group"><div class="facet-group-label">属性</div><div id="facetAttr" class="facet-row"></div></div>
    <div class="facet-group"><div class="facet-group-label">対象・関係性</div><div id="facetTarget" class="facet-row"></div></div>
    <div class="facet-group"><div class="facet-group-label">情報カテゴリ</div><div id="facetInfoCat" class="facet-row"></div></div>
    <div class="facet-actions">
      <button id="clearOthers" class="btn-ghost">属性/対象・関係性/情報カテゴリ 選択解除</button>
      <button id="clearAll" class="btn-ghost">全解除</button>
    </div>
  </div>

  <div class="table-area"><div id="table">ファイルを指定して「読み込む」を押してください。</div></div>

  <script>
    // ===== 設定 =====
    const DEFAULT_SRC = 'qa_questions_clean.json';

    // 大分類↔中分類（表示はコード＋名前、データは日本語名でフィルタ）
    const CATEGORY_MAP = [
      { code:'A', name:'個別支援・介入', mids:[
        {code:'A-1', name:'グレーゾーン対応'},
        {code:'A-2', name:'自己理解促進'},
        {code:'A-3', name:'配慮・申請'},
        {code:'A-4', name:'面談・コミュニケーション'},
        {code:'A-5', name:'家族との連携'},
      ]},
      { code:'B', name:'進路・企業・雇用', mids:[
        {code:'B-1', name:'雇用形態の選択'},
        {code:'B-2', name:'障害者雇用制度'},
        {code:'B-3', name:'キャリア計画'},
        {code:'B-4', name:'企業・採用情報'},
      ]},
      { code:'C', name:'支援体制・学内外連携', mids:[
        {code:'C-1', name:'学内連携・体制'},
        {code:'C-2', name:'学外連携・リファー'},
        {code:'C-3', name:'企業との連携'},
        {code:'C-4', name:'アウトリーチ'},
      ]},
      { code:'D', name:'事例・情報収集', mids:[
        {code:'D-1', name:'障害別事例'},
        {code:'D-2', name:'難病・その他事例'},
        {code:'D-3', name:'就労経験談'},
        {code:'D-4', name:'学内・外取り組み'},
      ]},
    ];

    // その他ファセット定義
    const FACET_OTHERS = [
      { key: '属性', title: '属性', elId: 'facetAttr' },
      { key: '対象・関係性', title: '対象・関係性', elId: 'facetTarget' },
      { key: '情報カテゴリ', title: '情報カテゴリ', elId: 'facetInfoCat' },
    ];

    // 分割セパレータ（その他ファセット専用）
    const TOKEN_SPLIT = /[,/|｜・;；、\s]+/g;

    // ワイド列（ゆらぎ吸収）
    const WIDE_QUESTION_KEYS = ['質問','質問文','質問（修正）','質問(修正)','questions','Questions'];
    const WIDE_ANSWER_KEYS   = ['回答','回答文','回答（修正）','回答(修正)','回答例','answer','Answer'];

    // ===== ユーティリティ =====
    const $ = (sel) => document.querySelector(sel);
    const isJson = (s) => /\.json(\?|#|$)/i.test((s||'').trim());
    const showError = (msg) => { $('#status').textContent = msg || ''; };
    const setLoading = (loading) => { $('#loadBtn').disabled = !!loading; $('#table').setAttribute('aria-busy', loading?'true':'false'); };
    const parseQueryHash = () => { const h = location.hash.slice(1); if (!h) return null; const p = new URLSearchParams(h); return p.get('src'); };
    const updateHash = (src) => { history.replaceState(null, '', '#src=' + encodeURIComponent(src)); };

    const trimOrEmpty = (v) => (v==null ? '' : String(v).trim());
    const toTokens = (v) => {
      const s = trimOrEmpty(v); if (!s) return [];
      return [...new Set(s.split(TOKEN_SPLIT).map(x=>x.trim()).filter(Boolean))];
    };

    // ===== データ保持 =====
    let originalRows = [];
    let allColumns = [];
    let facetIndex = {};
    let facetSelections = {
      '大分類': new Set(),
      '中分類': new Set(),
      '属性': new Set(),
      '対象・関係性': new Set(),
      '情報カテゴリ': new Set(),
    };

    // ===== Grid列メタ（質問・回答をワイド化） =====
    const buildGridColumns = (columnKeys) => {
      const isWideQ = (k) => WIDE_QUESTION_KEYS.includes(k);
      const isWideA = (k) => WIDE_ANSWER_KEYS.includes(k);
      return columnKeys.map(k => (isWideQ(k)||isWideA(k)) ? { id:k, name:k, width:'520px' } : { id:k, name:k });
    };

    // ===== Grid描画（毎回新規mount） =====
    const renderGrid = (columnKeys, rowsObjs) => {
      const gridColumns = buildGridColumns(columnKeys);
      const data = rowsObjs.map(r => columnKeys.map(c => r[c] ?? ''));
      const host = document.getElementById('table'); host.innerHTML = '';
      const mount = document.createElement('div'); host.appendChild(mount);
      const grid = new gridjs.Grid({
        columns: gridColumns, data,
        search:{enabled:true, placeholder:'検索...'}, sort:true,
        pagination:{enabled:true, limit:20},
        language:{ search:{placeholder:'検索...'}, pagination:{previous:'前', next:'次', showing:'表示中', results:'件'} }
      });
      requestAnimationFrame(()=>grid.render(mount));
    };

    // ===== インデックス作成（大分類/中分類は分割しない＝厳密一致、その他は分割） =====
    const buildFacetIndex = (rows) => {
      const keysAtomic = ['大分類','中分類'];                  // 分割しない
      const keysToken  = ['属性','対象・関係性','情報カテゴリ']; // 分割する

      const index = { '大分類': new Map(), '中分類': new Map(),
                      '属性': new Map(), '対象・関係性': new Map(), '情報カテゴリ': new Map() };

      rows.forEach((row, i) => {
        // Atomic
        keysAtomic.forEach(k => {
          const val = trimOrEmpty(row[k]);
          if (!val) return;
          if (!index[k].has(val)) index[k].set(val, new Set());
          index[k].get(val).add(i);
        });
        // Tokenized
        keysToken.forEach(k => {
          const tokens = toTokens(row[k]);
          tokens.forEach(v => {
            if (!index[k].has(v)) index[k].set(v, new Set());
            index[k].get(v).add(i);
          });
        });
      });
      return index;
    };

    // ===== UI更新／フィルタ =====
    const syncPillUI = () => {
      document.querySelectorAll('.pill').forEach(el => {
        const facet = el.dataset.facet, val = el.dataset.value;
        el.setAttribute('data-on', facetSelections[facet]?.has(val) ? '1':'0');
      });
    };

    const applyFacetFilter = () => {
      // 各ファセットは OR、ファセット間は AND（= 全条件を満たす行）
      let candidate = null;
      for (const facet of Object.keys(facetSelections)) {
        const sel = facetSelections[facet]; if (!sel || sel.size === 0) continue;
        const orSet = new Set();
        sel.forEach(v => { const s = facetIndex[facet]?.get(v); if (s) s.forEach(i=>orSet.add(i)); });
        candidate = (candidate==null) ? orSet : new Set([...candidate].filter(i => orSet.has(i)));
      }
      const filteredRows = (candidate==null) ? originalRows : [...candidate].sort((a,b)=>a-b).map(i => originalRows[i]);
      renderGrid(allColumns, filteredRows);
    };

    const clearSelections = (keys) => {
      keys.forEach(k => facetSelections[k]?.clear());
      syncPillUI(); renderMidFacet(); applyFacetFilter();
    };

    // ===== 大分類描画（コードは表示のみ。フィルタは日本語名で実施） =====
    const renderTopFacet = () => {
      const wrap = $('#facetTopRow'); wrap.innerHTML = '';
      const idx = facetIndex['大分類'] || new Map();
      CATEGORY_MAP.forEach(cat => {
        const valName = cat.name; // データ上の値（日本語）
        const count = idx.get(valName)?.size || 0;
        const pill = document.createElement('button');
        pill.className = 'pill'; pill.dataset.facet = '大分類'; pill.dataset.value = valName;
        pill.innerHTML = `<span>${cat.code} ${valName}</span><span class="count">${count}</span>`;
        pill.addEventListener('click', () => {
          const set = facetSelections['大分類']; set.has(valName) ? set.delete(valName) : set.add(valName);
          syncPillUI(); renderMidFacet(); applyFacetFilter();
        });
        wrap.appendChild(pill);
      });
    };

    // ===== 中分類描画（大分類選択に応じて表示を絞るが、フィルタは独立） =====
    const renderMidFacet = () => {
      const host = $('#facetMid'); host.innerHTML = '';
      const selectedBigs = [...facetSelections['大分類']];
      const midIdx = facetIndex['中分類'] || new Map();

      const groups = (selectedBigs.length>0)
        ? CATEGORY_MAP.filter(cat => selectedBigs.includes(cat.name))
        : CATEGORY_MAP;

      groups.forEach(cat => {
        const g = document.createElement('div'); g.className = 'facet-group';
        const label = document.createElement('div'); label.className = 'facet-group-label';
        label.textContent = `${cat.code} ${cat.name}`; g.appendChild(label);

        const row = document.createElement('div'); row.className = 'facet-row';
        cat.mids.forEach(m => {
          const valName = m.name; const count = midIdx.get(valName)?.size || 0;
          const pill = document.createElement('button');
          pill.className = 'pill'; pill.dataset.facet = '中分類'; pill.dataset.value = valName;
          pill.innerHTML = `<span>${m.code} ${valName}</span><span class="count">${count}</span>`;
          pill.addEventListener('click', () => {
            const set = facetSelections['中分類']; set.has(valName) ? set.delete(valName) : set.add(valName);
            syncPillUI(); applyFacetFilter(); // ← 大分類の一致有無に関わらず中分類は有効
          });
          row.appendChild(pill);
        });
        g.appendChild(row); host.appendChild(g);
      });

      syncPillUI();
    };

    // ===== その他ファセット描画 =====
    const renderOtherFacets = () => {
      FACET_OTHERS.forEach(def => {
        const el = document.getElementById(def.elId); el.innerHTML = '';
        const idx = facetIndex[def.key] || new Map();
        [...idx.entries()].sort((a,b)=> b[1].size - a[1].size).forEach(([val, set]) => {
          const pill = document.createElement('button');
          pill.className = 'pill'; pill.dataset.facet = def.key; pill.dataset.value = val;
          pill.innerHTML = `<span>${val}</span><span class="count">${set.size}</span>`;
          pill.addEventListener('click', () => {
            const s = facetSelections[def.key]; s.has(val) ? s.delete(val) : s.add(val);
            syncPillUI(); applyFacetFilter();
          });
          el.appendChild(pill);
        });
      });
      syncPillUI();
    };

    // ===== データロード =====
    const normalizeToArrayOfObjects = (data) => {
      let arr = [];
      if (Array.isArray(data)) arr = data;
      else if (Array.isArray(data?.data)) arr = data.data;
      else if (Array.isArray(data?.rows) && Array.isArray(data?.header)) {
        arr = data.rows.map(r => Object.fromEntries(data.header.map((h,idx)=>[h, r[idx]])));
      }
      return arr.map(o => { const out={}; Object.keys(o||{}).forEach(k => out[k]= (o[k]==null?'':String(o[k])) ); return out; });
    };
    const detectColumns = (arr) => { if (!arr.length) return []; const s=new Set(); arr.forEach(o=>Object.keys(o||{}).forEach(k=>s.add(k))); return [...s]; };

    const loadCsv  = async (url) => { const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`CSV取得に失敗しました (${r.status})`); const t=await r.text(); const p=Papa.parse(t,{header:true, skipEmptyLines:true}); return normalizeToArrayOfObjects(p.data); };
    const loadJson = async (url) => { const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`JSON取得に失敗しました (${r.status})`); const j=await r.json(); return normalizeToArrayOfObjects(j); };

    let loadingPromise = null;
    const loadBySrc = async (src) => {
      if (!src) { showError('データURLを入力してください'); return; }
      showError(''); setLoading(true);
      try {
        if (loadingPromise) await loadingPromise;
        loadingPromise = (isJson(src) ? loadJson(src) : loadCsv(src));
        const arr = await loadingPromise;

        originalRows = arr;
        allColumns = detectColumns(arr);

        facetIndex = buildFacetIndex(arr); // ← 修正ポイント（大分類/中分類は分割しない）
        renderTopFacet();
        renderMidFacet();
        renderOtherFacets();

        renderGrid(allColumns, originalRows);

        // クリア
        $('#clearTop').onclick   = () => clearSelections(['大分類']);
        $('#clearMid').onclick   = () => clearSelections(['中分類']);
        $('#clearOthers').onclick= () => clearSelections(['属性','対象・関係性','情報カテゴリ']);
        $('#clearAll').onclick   = () => clearSelections(['大分類','中分類','属性','対象・関係性','情報カテゴリ']);

      } catch (e) {
        showError(e.message || String(e));
        document.getElementById('table').textContent = '読み込みに失敗しました。';
        console.error(e);
      } finally {
        setLoading(false); loadingPromise = null;
      }
    };

    // ===== イベント/初期化 =====
    document.getElementById('loadBtn').addEventListener('click', () => {
      const raw = document.getElementById('sheetUrl').value.trim(); loadBySrc(raw); updateHash(raw);
    });
    document.getElementById('sheetUrl').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); document.getElementById('loadBtn').click(); }
    });
    (async () => {
      const fromHash = parseQueryHash(); const initial = fromHash || DEFAULT_SRC;
      document.getElementById('sheetUrl').value = initial; await loadBySrc(initial); updateHash(initial);
    })();
  </script>
</body>
</html>
